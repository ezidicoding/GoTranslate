<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GoTranslate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>


    <style>
        :root {
            --app-bg: #f8f9fa;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --primary-color: #006a6a;
            --secondary-color: #e0eef0;
            --border-color: #dfe1e5;
            --white: #ffffff;
            --danger-color: #d93025;
            --favorite-color: #ffc107; /* Gold for favorite */
        }

        html {
            font-size: 16px;
        }

        body {
            margin: 0;
            font-family: 'Noto Kufi Arabic', sans-serif;
            background-color: var(--app-bg);
            min-height: 100vh;
            direction: rtl;
        }

        .app-container {
            width: 100%;
            min-height: 100vh;
            background-color: var(--app-bg);
            box-shadow: none;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 0;
        }

        header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 16px;
            flex-shrink: 0;
            /* Removed border-bottom for a more unified single-interface look */
        } 

        .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 auto 0 0;
        }

        .star-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        main {
            flex-grow: 1;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
        }

        .text-area-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .source-wrapper, .translated-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px;
        }
        
        .translated-wrapper {
            border-top: 1px solid var(--border-color);
            min-height: 150px;
        }

        #source-text, #translated-text {
            width: 100%;
            border: none;
            outline: none;
            background-color: transparent;
            font-family: inherit;
            resize: none;
            padding: 0;
            box-sizing: border-box;
            font-size: 1.8rem;
            text-align: right;
            position: relative;
            z-index: 1;
            line-height: 1.5;
        } 

        #source-text {
            flex-grow: 1;
            color: var(--text-primary);
        }

        #source-text::placeholder {
            color: var(--text-secondary);
        }
        
        #translated-text {
             color: var(--text-primary);
             flex-grow: 1;
             padding-top: 15Ø¯px;
        }
        
        /* Style for readonly textarea to show it's not for typing */
        #translated-text[readonly] {
            cursor: default;
        }

        .text-area-control-btn {
            position: absolute;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.1rem;
            color: var(--text-secondary);
            z-index: 2;
        }

        #paste-btn {
            bottom: 10px;
            right: 10px;
            background-color: var(--secondary-color);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #speak-source-btn {
            top: 5px;
            left: 5px;
        }

        #speak-translated-btn {
            top: 5px;
            right: 5px;
        }

        #favorite-btn {
            top: 5px;
            left: 5px;
            font-size: 1.2rem;
        }

        #favorite-btn.is-favorite {
            color: var(--favorite-color);
        }

        #status-message {
            text-align: center;
            color: var(--text-secondary);
            height: 20px;
            padding: 5px 0;
            font-size: 0.9rem;
            transition: opacity 0.3s ease;
        }

        .language-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 16px;
            background-color: var(--app-bg);
            flex-shrink: 0;
        }

        .lang-container {
            flex: 1;
        }

        .lang-btn {
            width: 100%;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 1rem;
            font-weight: 500;
            font-family: inherit;
            color: var(--text-primary);
            text-align: center;
            cursor: pointer;
            appearance: none;
        }

        #swap-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 16px 8px;
            background-color: var(--secondary-color);
            flex-shrink: 0;
        }

        .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex-basis: 33%;
            cursor: pointer;
        }

        .action-item p {
            margin: 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
            font-size: 1.25rem;
            background-color: #d1e2e3;
            border: none;
        }

        #mic-btn {
            width: 64px;
            height: 64px;
            background-color: var(--primary-color);
            color: var(--white);
            font-size: 1.75rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: background-color 0.3s ease;
        }

        #mic-btn.is-listening {
            background-color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(217, 48, 37, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(217, 48, 37, 0); }
            80% { box-shadow: 0 0 0 0 rgba(217, 48, 37, 0); }
        }

        /* Saved Words Modal */
        .saved-words-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .saved-words-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .saved-words-modal-content {
            background-color: var(--white);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .saved-words-modal-overlay.active .saved-words-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .saved-words-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .saved-words-modal-header h2 { margin: 0; font-size: 1.2rem; color: var(--text-primary); }
        .saved-words-modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 5px; }
        .saved-words-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .saved-words-list li { display: flex; flex-direction: column; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .saved-words-list li:last-child { border-bottom: none; }
        .saved-words-list .phrase-text { font-size: 1rem; color: var(--text-primary); margin-bottom: 5px; }
        .saved-words-list .original-text { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
        .saved-words-list .delete-btn { background-color: var(--danger-color); color: var(--white); border: none; border-radius: 5px; padding: 8px 12px; cursor: pointer; font-size: 0.85rem; align-self: flex-end; }
        .saved-words-list p.no-phrases { text-align: center; color: var(--text-secondary); padding: 20px; }

        /* --- NEW: ACCESSIBILITY & UX - Custom Focus Indicator --- */
        /* Removes the default blue outline and replaces it with a subtle, on-brand glow for keyboard navigation */
        button:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        .action-item:focus-visible,
        .star-icon:focus-visible,
        .saved-words-modal-close-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--secondary-color);
            border-radius: 5px; /* Add a slight radius to the focus shadow */
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <img src="https://i.imgur.com/uX1y0c8.png" alt="Profile" class="profile-pic">
            <h1 class="title">GoTranslate</h1>
            <i class="fa-solid fa-star star-icon" id="header-star-btn" tabindex="0"></i> <!-- Added tabindex for focus -->
        </header>

        <main>
            <div class="text-area-container">
                <div class="source-wrapper">
                    <textarea id="source-text" placeholder="Ø¥Ø¯Ø®Ø§Ù ÙØµ"></textarea>
                    <button id="paste-btn" class="text-area-control-btn">
                        <i class="fa-regular fa-paste"></i>
                        <span>ÙØµÙ</span>
                    </button>
                    <button id="speak-source-btn" class="text-area-control-btn">
                        <i class="fa-solid fa-volume-high"></i>
                    </button>
                </div>
                <div id="status-message"></div>
                <div class="translated-wrapper">
                    <!-- CHANGED: Now a readonly textarea -->
                    <textarea id="translated-text" readonly></textarea>
                    <button id="favorite-btn" class="text-area-control-btn">
                        <i class="fa-regular fa-star"></i>
                    </button>
                    <button id="speak-translated-btn" class="text-area-control-btn">
                        <i class="fa-solid fa-volume-high"></i>
                    </button>
                </div>
            </div>
        </main>

        <div class="language-selector">
            <div class="lang-container">
                 <select id="source-lang" class="lang-btn"></select>
            </div>
            <button id="swap-btn"><i class="fa-solid fa-right-left"></i></button>
            <div class="lang-container">
                 <select id="target-lang" class="lang-btn"></select>
            </div>
        </div>

        <footer>
            <div class="action-item" id="camera-btn" tabindex="0"> <!-- Added tabindex for focus -->
                <div class="icon-wrapper"><i class="fa-solid fa-camera-retro"></i></div>
                <p>Ø§ÙÙØ§ÙÙØ±Ø§</p>
            </div>
            <div class="action-item">
                <button class="icon-wrapper" id="mic-btn"><i class="fa-solid fa-microphone"></i></button>
            </div>
            <div class="action-item" id="conversation-btn" tabindex="0"> <!-- Added tabindex for focus -->
                <div class="icon-wrapper"><i class="fa-solid fa-users"></i></div>
                <p>ÙØ­Ø§Ø¯Ø«Ø©</p>
            </div>
        </footer>

        <!-- Saved Words Modal -->
        <div class="saved-words-modal-overlay" id="saved-words-modal-overlay">
            <div class="saved-words-modal-content">
                <div class="saved-words-modal-header">
                    <h2>Ø§ÙØ¹Ø¨Ø§Ø±Ø§Øª Ø§ÙÙØ­ÙÙØ¸Ø©</h2>
                    <button class="saved-words-modal-close-btn" id="close-saved-modal-btn">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <ul class="saved-words-list" id="saved-words-list">
                    <!-- Saved phrases will be loaded here by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sourceLang = document.getElementById('source-lang');
            const targetLang = document.getElementById('target-lang');
            const sourceText = document.getElementById('source-text');
            const translatedText = document.getElementById('translated-text');
            const statusMessage = document.getElementById('status-message');
            const swapBtn = document.getElementById('swap-btn');
            const pasteBtn = document.getElementById('paste-btn');
            const micBtn = document.getElementById('mic-btn');
            const cameraBtn = document.getElementById('camera-btn');
            const conversationBtn = document.getElementById('conversation-btn');
            const speakSourceBtn = document.getElementById('speak-source-btn');
            const speakTranslatedBtn = document.getElementById('speak-translated-btn');
            const favoriteBtn = document.getElementById('favorite-btn');
            const headerStarBtn = document.getElementById('header-star-btn');
            const savedWordsModalOverlay = document.getElementById('saved-words-modal-overlay');
            const closeSavedModalBtn = document.getElementById('close-saved-modal-btn');
            const savedWordsList = document.getElementById('saved-words-list');

            // --- NEW: Added 'yz_kmr' for Yezidi and 'kmr' for Kurmanji ---
            const languages = {
                'ar': 'Ø§ÙØ¹Ø±Ø¨ÙØ©', 'en': 'Ø§ÙØ¥ÙØ¬ÙÙØ²ÙØ©', 'nl': 'Ø§ÙÙÙÙÙØ¯ÙØ©', 'fr': 'Ø§ÙÙØ±ÙØ³ÙØ©', 'de': 'Ø§ÙØ£ÙÙØ§ÙÙØ©', 'es': 'Ø§ÙØ¥Ø³Ø¨Ø§ÙÙØ©',
                'it': 'Ø§ÙØ¥ÙØ·Ø§ÙÙØ©', 'ja': 'Ø§ÙÙØ§Ø¨Ø§ÙÙØ©', 'ko': 'Ø§ÙÙÙØ±ÙØ©', 'pt': 'Ø§ÙØ¨Ø±ØªØºØ§ÙÙØ©', 'ru': 'Ø§ÙØ±ÙØ³ÙØ©', 'zh-CN': 'Ø§ÙØµÙÙÙØ© (ÙØ¨Ø³Ø·Ø©)',
                'yz_kmr': 'Ø§ÙÙØºØ© Ø§ÙØ§ÙØ²ÙØ¯ÙØ©', // Yezidi language code
                'kmr': 'Ø§ÙÙØ±Ø¯ÙØ© Ø§ÙÙØ±ÙØ§ÙØ¬ÙØ©', // Kurdish Kurmanji
                'af': 'Ø§ÙØ£ÙØ±ÙÙØ§ÙÙØ©', 'sq': 'Ø§ÙØ£ÙØ¨Ø§ÙÙØ©', 'am': 'Ø§ÙØ£ÙÙØ±ÙØ©', 'hy': 'Ø§ÙØ£Ø±ÙÙÙØ©', 'az': 'Ø§ÙØ£Ø°Ø±Ø¨ÙØ¬Ø§ÙÙØ©', 'eu': 'Ø§ÙØ¨Ø§Ø³ÙÙØ©', 'be': 'Ø§ÙØ¨ÙÙØ§Ø±ÙØ³ÙØ©', 'bn': 'Ø§ÙØ¨ÙØºØ§ÙÙØ©', 'bs': 'Ø§ÙØ¨ÙØ³ÙÙØ©', 'bg': 'Ø§ÙØ¨ÙØºØ§Ø±ÙØ©', 'ca': 'Ø§ÙÙØªØ§ÙÙÙÙØ©', 'ceb': 'Ø§ÙØ³ÙØ¨ÙÙØ§ÙÙØ©', 'ny': 'Ø§ÙØ´ÙØ´ÙÙØ§', 'zh-TW': 'Ø§ÙØµÙÙÙØ© (ØªÙÙÙØ¯ÙØ©)', 'co': 'Ø§ÙÙÙØ±Ø³ÙÙÙØ©', 'hr': 'Ø§ÙÙØ±ÙØ§ØªÙØ©', 'cs': 'Ø§ÙØªØ´ÙÙÙØ©', 'da': 'Ø§ÙØ¯Ø§ÙÙØ±ÙÙØ©', 'et': 'Ø§ÙØ¥Ø³ØªÙÙÙØ©', 'tl': 'Ø§ÙÙÙØ¨ÙÙÙØ©', 'fi': 'Ø§ÙÙÙÙÙØ¯ÙØ©', 'fy': 'Ø§ÙÙØ±ÙØ²ÙØ©', 'gl': 'Ø§ÙØ¬Ø§ÙÙÙÙØ©', 'ka': 'Ø§ÙØ¬ÙØ±Ø¬ÙØ©', 'el': 'Ø§ÙÙÙÙØ§ÙÙØ©', 'gu': 'Ø§ÙÙØ¬Ø±Ø§ØªÙØ©', 'ht': 'Ø§ÙÙØ±ÙÙÙÙØ© Ø§ÙÙØ§ÙØªÙØ©', 'ha': 'Ø§ÙÙÙØ³Ø§', 'haw': 'ÙØºØ© ÙØ§ÙØ§Ù', 'iw': 'Ø§ÙØ¹Ø¨Ø±ÙØ©', 'hi': 'Ø§ÙÙÙØ¯ÙØ©', 'hmn': 'Ø§ÙÙÙÙÙØº', 'hu': 'Ø§ÙÙØ¬Ø±ÙØ©', 'is': 'Ø§ÙØ¢ÙØ³ÙÙØ¯ÙØ©', 'ig': 'Ø§ÙØ¥ÙØºØ¨Ù', 'id': 'Ø§ÙØ¥ÙØ¯ÙÙÙØ³ÙØ©', 'ga': 'Ø§ÙØ£ÙØ±ÙÙØ¯ÙØ©', 'jw': 'Ø§ÙØ¬Ø§ÙÙØ©', 'kn': 'Ø§ÙÙÙØ§Ø¯ÙØ©', 'kk': 'Ø§ÙÙØ§Ø²Ø§Ø®Ø³ØªØ§ÙÙØ©', 'km': 'Ø§ÙØ®ÙÙØ±ÙØ©', 'ku': 'Ø§ÙÙØ±Ø¯ÙØ© (ÙÙØ±ÙØ§ÙØ¬Ù)', 'ky': 'Ø§ÙÙØ±ØºÙØ²ÙØ©', 'lo': 'Ø§ÙÙØ§ÙÙØ©', 'la': 'Ø§ÙÙØ§ØªÙÙÙØ©', 'lv': 'Ø§ÙÙØ§ØªÙÙØ©', 'lt': 'Ø§ÙÙÙØªÙØ§ÙÙØ©', 'lb': 'Ø§ÙÙÙÙØ³ÙØ¨Ø±Ø¬ÙØ©', 'mk': 'Ø§ÙÙÙØ¯ÙÙÙØ©', 'mg': 'Ø§ÙÙØ§ÙØ§Ø¬Ø§Ø´ÙØ©', 'ms': 'Ø§ÙÙÙØ§ÙÙ', 'ml': 'Ø§ÙÙØ§ÙÙØ§ÙØ§ÙÙØ©', 'mt': 'Ø§ÙÙØ§ÙØ·ÙØ©', 'mi': 'Ø§ÙÙØ§ÙØ±ÙØ©', 'mr': 'Ø§ÙÙØ§Ø±Ø§Ø«ÙØ©', 'mn': 'Ø§ÙÙÙØºÙÙÙØ©', 'my': 'Ø§ÙØ¨ÙØ±ÙÙØ©', 'ne': 'Ø§ÙÙÙØ¨Ø§ÙÙØ©', 'no': 'Ø§ÙÙØ±ÙÙØ¬ÙØ©', 'ps': 'Ø§ÙØ¨Ø´ØªÙÙØ©', 'fa': 'Ø§ÙÙØ§Ø±Ø³ÙØ©', 'pl': 'Ø§ÙØ¨ÙÙÙØ¯ÙØ©', 'pa': 'Ø§ÙØ¨ÙØ¬Ø§Ø¨ÙØ©', 'ro': 'Ø§ÙØ±ÙÙØ§ÙÙØ©', 'sm': 'Ø§ÙØ³Ø§ÙÙÙØ©', 'gd': 'Ø§ÙØºÙÙÙØ© Ø§ÙØ£Ø³ÙØªÙÙØ¯ÙØ©', 'sr': 'Ø§ÙØµØ±Ø¨ÙØ©', 'st': 'Ø§ÙØ³ÙØ«ÙÙØ©', 'sn': 'Ø§ÙØ´ÙÙØ§', 'sd': 'Ø§ÙØ³ÙØ¯ÙØ©', 'si': 'Ø§ÙØ³ÙÙØ§ÙÙØ©', 'sk': 'Ø§ÙØ³ÙÙÙØ§ÙÙØ©', 'sl': 'Ø§ÙØ³ÙÙÙÙÙÙØ©', 'so': 'Ø§ÙØµÙÙØ§ÙÙØ©', 'su': 'Ø§ÙØ³ÙÙØ¯Ø§ÙÙØ©', 'sw': 'Ø§ÙØ³ÙØ§Ø­ÙÙÙØ©', 'sv': 'Ø§ÙØ³ÙÙØ¯ÙØ©', 'tg': 'Ø§ÙØ·Ø§Ø¬ÙÙÙØ©', 'ta': 'Ø§ÙØªØ§ÙÙÙÙØ©', 'te': 'Ø§ÙØªÙÙØ¬Ù', 'th': 'Ø§ÙØªØ§ÙÙØ§ÙØ¯ÙØ©', 'tr': 'Ø§ÙØªØ±ÙÙØ©', 'uk': 'Ø§ÙØ£ÙÙØ±Ø§ÙÙØ©', 'ur': 'Ø§ÙØ£Ø±Ø¯ÙØ©', 'uz': 'Ø§ÙØ£ÙØ²Ø¨ÙÙØ©', 'vi': 'Ø§ÙÙÙØªÙØ§ÙÙØ©', 'cy': 'Ø§ÙÙÙÙØ²ÙØ©', 'xh': 'Ø§ÙØ®ÙØ³Ø§', 'yi': 'Ø§ÙÙØ¯ÙØ´ÙØ©', 'yo': 'Ø§ÙÙÙØ±Ø¨Ø§', 'zu': 'Ø§ÙØ²ÙÙÙ'
            };

            const SAVED_PHRASES_KEY = 'GOOGLE_TRANSLATE_CLONE_SAVED_PHRASES';

            function populateLanguages() {
                // --- NEW: Sort languages to show custom ones on top ---
                const sortedLangs = Object.entries(languages).sort((a, b) => {
                    if (a[0] === 'yz_kmr' || a[0] === 'kmr') return -1;
                    if (b[0] === 'yz_kmr' || b[0] === 'kmr') return 1;
                    return a[1].localeCompare(b[1], 'ar');
                });
            
                sortedLangs.forEach(([code, name]) => {
                    const option1 = new Option(name, code);
                    const option2 = new Option(name, code);
                    sourceLang.add(option1);
                    targetLang.add(option2);
                });

                sourceLang.value = 'ar';
                targetLang.value = 'yz_kmr';
            }

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // --- NEW: Function to apply Yezidi custom transformations ---
            async function applyYezidiTransformations(kurmanjiText) {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/ezidicoding/ezidicode.com/refs/heads/main/word.json');
                    if (!response.ok) throw new Error('Failed to load custom dictionary');
                    const customData = await response.json();
                    const corrections = customData.corrections;
                    let text = ` ${kurmanjiText} `; // Add padding for better regex matching

                    // Sort keys by length, longest first, to avoid partial replacements
                    const sortedKeys = Object.keys(corrections).sort((a, b) => b.length - a.length);

                    sortedKeys.forEach(key => {
                        // Use a regex to replace whole words/phrases, case-insensitive
                        const regex = new RegExp(`\\b${key}\\b`, 'gi');
                        text = text.replace(regex, corrections[key]);
                    });

                    // Fallback transliteration for words not in the dictionary
                    const translitMap = {
                        'Ã§': 'Ú', 'Å': 'Ø´', 'b': 'Ø¨', 'c': 'Ø¬', 'd': 'Ø¯', 'f': 'Ù', 'g': 'Ú¯', 'h': 'Ù',
                        'j': 'Ú', 'k': 'Ú©', 'l': 'Ù', 'm': 'Ù', 'n': 'Ù', 'p': 'Ù¾', 'q': 'Ù', 'r': 'Ø±',
                        's': 'Ø³', 't': 'Øª', 'v': 'Ù', 'w': 'Ù', 'x': 'Ø®', 'y': 'Ù', 'z': 'Ø²',
                        'Ãª': 'Ù', 'Ã®': 'Ù', 'Ã»': 'Ù', 'a': 'Ø§', 'e': 'Ø§', 'u': 'Ù', 'o':'Ù', 'i': ''
                    };

                    for (const [latin, arabic] of Object.entries(translitMap)) {
                        text = text.replace(new RegExp(latin, 'g'), arabic);
                        text = text.replace(new RegExp(latin.toUpperCase(), 'g'), arabic);
                    }
                    
                    return text.trim();

                } catch (error) {
                    console.error("Yezidi transformation error:", error);
                    return "Ø®Ø·Ø£ ÙÙ ØªØ·Ø¨ÙÙ Ø§ÙØªØ­ÙÙÙ Ø§ÙØ¥ÙØ²ÙØ¯Ù";
                }
            }
            
            const translateText = async () => {
                const textToTranslate = sourceText.value.trim();
                const sl = sourceLang.value;
                let tl = targetLang.value;

                if (!textToTranslate) {
                    translatedText.value = '';
                    statusMessage.textContent = '';
                    updateFavoriteButtonState();
                    return;
                }

                translatedText.value = 'ÙØªØ±Ø¬Ù...';
                
                // --- NEW: Logic for Yezidi Translation ---
                const isYezidiTarget = tl === 'yz_kmr';
                const apiTargetLang = isYezidiTarget ? 'kmr' : tl;

                const apiUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${apiTargetLang}&dt=t&q=${encodeURIComponent(textToTranslate)}`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    let resultText = data[0].map(item => item[0]).join('');

                    if (isYezidiTarget) {
                        translatedText.value = await applyYezidiTransformations(resultText);
                    } else {
                        translatedText.value = resultText;
                    }

                    statusMessage.textContent = '';
                    updateFavoriteButtonState();
                } catch (error) {
                    console.error('Error during translation:', error);
                    translatedText.value = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«ÙØ§Ø¡ Ø§ÙØªØ±Ø¬ÙØ©. ÙØ±Ø¬Ù Ø§ÙÙØ­Ø§ÙÙØ© ÙØ±Ø© Ø£Ø®Ø±Ù.';
                    statusMessage.textContent = 'ÙØ´ÙØª Ø§ÙØªØ±Ø¬ÙØ©';
                    updateFavoriteButtonState();
                    setTimeout(() => statusMessage.textContent = '', 3000);
                }
            };
            
            const debouncedTranslate = debounce(translateText, 500);

            function swapLanguages() {
                const tempLang = sourceLang.value;
                sourceLang.value = targetLang.value;
                targetLang.value = tempLang;
                const tempSourceText = sourceText.value;
                sourceText.value = translatedText.value;
                translatedText.value = tempSourceText;  
                if(sourceText.value.trim()){
                    translateText();
                } else {
                    translatedText.value = '';
                    statusMessage.textContent = '';
                    updateFavoriteButtonState();
                }
            }
            
            async function pasteText() {
                try {
                    const text = await navigator.clipboard.readText();
                    sourceText.value = (sourceText.value.trim() === '' ? '' : sourceText.value + ' ') + text;
                    sourceText.focus();
                    sourceText.selectionStart = sourceText.selectionEnd = sourceText.value.length;
                    translateText();
                } catch (error) {
                    console.error('Failed to read clipboard contents: ', error);
                    alert('ÙÙ ÙØªÙÙÙ ÙÙ ÙØµÙ Ø§ÙÙØµ. ÙØ±Ø¬Ù Ø§ÙØªØ­ÙÙ ÙÙ Ø£Ø°ÙÙØ§Øª Ø§ÙÙØªØµÙØ­.');
                }
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false; recognition.interimResults = false;
                recognition.onstart = () => { micBtn.classList.add('is-listening'); statusMessage.textContent = 'Ø§Ø³ØªÙØ¹...'; };
                recognition.onend = () => { micBtn.classList.remove('is-listening'); if (statusMessage.textContent === 'Ø§Ø³ØªÙØ¹...') statusMessage.textContent = ''; };
                recognition.onerror = (event) => { console.error('Speech recognition error', event.error); statusMessage.textContent = 'Ø®Ø·Ø£ ÙÙ Ø§ÙØªØ¹Ø±Ù Ø¹ÙÙ Ø§ÙØµÙØª: ' + event.error; micBtn.classList.remove('is-listening'); setTimeout(() => statusMessage.textContent = '', 3000); };
                recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; sourceText.value = (sourceText.value.trim() === '' ? '' : sourceText.value + ' ') + transcript; debouncedTranslate(); };
                micBtn.addEventListener('click', () => { if (micBtn.classList.contains('is-listening')) { recognition.stop(); } else { recognition.lang = sourceLang.value; recognition.start(); } });
            } else { micBtn.disabled = true; micBtn.style.opacity = 0.5; micBtn.style.cursor = 'not-allowed'; }

            function speakText(text, langCode) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    // --- NEW: Use 'kmr' for TTS if language is 'yz_kmr' ---
                    const speechLang = langCode === 'yz_kmr' ? 'kmr' : langCode;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = speechLang;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Ø¹Ø°Ø±Ø§ÙØ ÙØªØµÙØ­Ù ÙØ§ ÙØ¯Ø¹Ù ØªØ­ÙÙÙ Ø§ÙÙØµ Ø¥ÙÙ ÙÙØ§Ù (Text-to-Speech).');
                }
            }

            function generateUniqueId() { return '_' + Math.random().toString(36).substr(2, 9); }
            function loadSavedPhrases() { const data = localStorage.getItem(SAVED_PHRASES_KEY); return data ? JSON.parse(data) : []; }
            function savePhrases(phrases) { localStorage.setItem(SAVED_PHRASES_KEY, JSON.stringify(phrases)); }

            function isCurrentTranslationSaved() {
                const currentOriginal = sourceText.value.trim();
                const currentTranslated = translatedText.value.trim();
                if (!currentOriginal || !currentTranslated) return false;
                const savedPhrases = loadSavedPhrases();
                return savedPhrases.some(p => p.originalText === currentOriginal && p.translatedText === currentTranslated && p.sourceLang === sourceLang.value && p.targetLang === targetLang.value);
            }

            function updateFavoriteButtonState() {
                const icon = favoriteBtn.querySelector('i');
                if (isCurrentTranslationSaved()) {
                    favoriteBtn.classList.add('is-favorite');
                    icon.classList.remove('fa-regular');
                    icon.classList.add('fa-solid');
                } else {
                    favoriteBtn.classList.remove('is-favorite');
                    icon.classList.remove('fa-solid');
                    icon.classList.add('fa-regular');
                }
            }

            function toggleFavorite() {
                const currentOriginal = sourceText.value.trim();
                const currentTranslated = translatedText.value.trim();
                if (!currentOriginal || !currentTranslated || currentTranslated === 'ÙØªØ±Ø¬Ù...') { alert('ÙØ§ ÙÙØ¬Ø¯ ÙØµ ÙØªØ±Ø¬ÙØªÙ Ø£Ù ØªØ±Ø¬ÙØ© ÙØ­ÙØ¸ÙØ§.'); return; }
                let savedPhrases = loadSavedPhrases();
                if (isCurrentTranslationSaved()) {
                    savedPhrases = savedPhrases.filter(p => !(p.originalText === currentOriginal && p.translatedText === currentTranslated && p.sourceLang === sourceLang.value && p.targetLang === targetLang.value));
                } else {
                    savedPhrases.push({ id: generateUniqueId(), originalText: currentOriginal, translatedText: currentTranslated, sourceLang: sourceLang.value, targetLang: targetLang.value, timestamp: Date.now() });
                }
                savePhrases(savedPhrases);
                updateFavoriteButtonState();
                renderSavedPhrases();
            }

            function renderSavedPhrases() {
                const savedPhrases = loadSavedPhrases().sort((a, b) => b.timestamp - a.timestamp);
                savedWordsList.innerHTML = '';
                if (savedPhrases.length === 0) {
                    savedWordsList.innerHTML = '<p class="no-phrases">ÙØ§ ØªÙØ¬Ø¯ Ø¹Ø¨Ø§Ø±Ø§Øª ÙØ­ÙÙØ¸Ø© Ø¨Ø¹Ø¯.</p>';
                    return;
                }
                savedPhrases.forEach(phrase => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<p class="phrase-text"><strong>${phrase.translatedText}</strong></p><p class="original-text">${phrase.originalText} (${languages[phrase.sourceLang] || phrase.sourceLang} -> ${languages[phrase.targetLang] || phrase.targetLang})</p><button class="delete-btn" data-id="${phrase.id}">Ø­Ø°Ù</button>`;
                    savedWordsList.appendChild(listItem);
                });
                savedWordsList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const idToDelete = event.target.dataset.id;
                        let phrases = loadSavedPhrases().filter(p => p.id !== idToDelete);
                        savePhrases(phrases);
                        renderSavedPhrases();
                        updateFavoriteButtonState();
                    });
                });
            }

            sourceText.addEventListener('input', debouncedTranslate);
            sourceLang.addEventListener('change', translateText); 
            targetLang.addEventListener('change', translateText); 
            swapBtn.addEventListener('click', swapLanguages);
            pasteBtn.addEventListener('click', pasteText);
            speakSourceBtn.addEventListener('click', () => speakText(sourceText.value, sourceLang.value));
            speakTranslatedBtn.addEventListener('click', () => {
                // For Yezidi, we speak the original Kurmanji text before conversion, which isn't stored.
                // This will speak the Arabic-script version which might not work well with TTS.
                // A more advanced implementation would store the intermediate Latin result.
                if (targetLang.value === 'yz_kmr') {
                     alert('Ø§ÙÙØ·Ù Ø§ÙØµÙØªÙ ØºÙØ± ÙØªØ§Ø­ Ø­Ø§ÙÙÙØ§ ÙÙØºØ© Ø§ÙØ§ÙØ²ÙØ¯ÙØ©.');
                     return;
                }
                speakText(translatedText.value, targetLang.value)
            }); 
            favoriteBtn.addEventListener('click', toggleFavorite);

            function openModal() { renderSavedPhrases(); savedWordsModalOverlay.classList.add('active'); }
            function closeModal() { savedWordsModalOverlay.classList.remove('active'); }

            headerStarBtn.addEventListener('click', openModal);
            headerStarBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') openModal(); });

            closeSavedModalBtn.addEventListener('click', closeModal);
            savedWordsModalOverlay.addEventListener('click', (event) => { if (event.target === savedWordsModalOverlay) closeModal(); });

            [cameraBtn, conversationBtn].forEach(btn => {
                const alertMsg = `ÙÙØ²Ø© ${btn.id === 'camera-btn' ? 'Ø§ÙÙØ§ÙÙØ±Ø§' : 'Ø§ÙÙØ­Ø§Ø¯Ø«Ø©'} ØºÙØ± ÙØªØ§Ø­Ø© ÙÙ ÙØ°Ø§ Ø§ÙØ¹Ø±Ø¶ Ø§ÙØªÙØ¶ÙØ­Ù.`;
                btn.addEventListener('click', () => alert(alertMsg));
                btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') alert(alertMsg); });
            });
            
            populateLanguages();
            updateFavoriteButtonState();
        });
    </script>

</body>
</html>
